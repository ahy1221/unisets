---
title: >
  An introduction to the `r Githubpkg("unisets")` package 
author:
- name: Kevin Rue-Albrecht
  affiliation: 
  - &id4 Kennedy Institute of Rheumatology, University of Oxford,
    Headington, Oxford OX3 7FY, UK.
  email: kevin.rue-albrecht@kennedy.ox.ac.uk
- name: Second Author
  affiliation: Second Author's Affiliation
date: "`r BiocStyle::doc_date()`"
package: "`r BiocStyle::pkg_ver('unisets')`"
output: 
  BiocStyle::html_document:
    toc_float: true
abstract: |
  Introduction to the `unisets` package.
vignette: |
  %\VignetteIndexEntry{1. Introduction to unisets}
  %\VignetteEncoding{UTF-8}  
  %\VignettePackage{unisets}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

# Installation

You can install the released version of unisets from [GitHub](https://github.com/kevinrue/unisets) with:

```{r, eval=FALSE}
devtools::install_github("kevinrue/unisets")
```

# Getting started

## The BaseSets class

This is a basic example which shows you how to create a `BaseSets` object, to store simple associations between genes and sets, along with optional metadata associated with each relation:

```{r, message=FALSE}
library(unisets)
gene_lists <- list(
    geneset1 = c("A", "B"),
    geneset2 = c("B", "C", "D")
)
relations_table <- DataFrame(
    element = unlist(gene_lists),
    set     = rep(names(gene_lists), lengths(gene_lists)),
    extra1 = sample(c("ABC", "DEF"), 5L, replace=TRUE),
    extra2 = rbinom(5L, 10L, 0.4)
)
base_sets <- BaseSets(relations_table)
base_sets
```

Metadata for each element and set can be provided as separate `DataFrame` objects:

```{r, message=FALSE}
gene_data <- IdVector(c("A", "B", "C", "D"))
elementMetadata(gene_data) <- DataFrame(
    stat1     = c( 1,   2,   3,   4 ),
    info1     = c("a", "b", "c", "d")
)
set_data <- IdVector(c("geneset1", "geneset2"))
elementMetadata(set_data) <- DataFrame(
    stat1     = c( 100,   200 ),
    info1     = c("abc", "def")
)
base_sets <- BaseSets(relations_table, gene_data, set_data)
base_sets
```

The `elementData`, and `setData` slots store metadata for each individual element and set that appears in the `relations` slot.
Those metadata can be accessed directly using the getter methods of the same name.

```{r}
elementData(base_sets)
setData(base_sets)
```

Note that relations between elements and sets are internally stored as an `r Biocpkg("S4Vectors")` `Hits` object.
This container efficiently represents a set of hits between a set of _left nodes_ and a set of _right nodes_, with optional metadata accompanying each hit.

```{r}
base_sets@relations
```

Conveniently, the `relations` accessor returns relations and associated metadata as a `DataFrame` substituting hits for their corresponding element and set identifiers.

```{r}
relations(base_sets)
```

## The FuzzySets class

Classes derived from `BaseSets` may add additional constraints on the relations to define special types of relationships between elements and sets.

For instance, the `FuzzySets` class is a direct extension of the `BaseSets` class where the metadata accompanying each relation must include at least a column called `"membership"` that holds the "membership function", a numeric value in the interval [0,1] that provides a measure of partial membership between elements and sets.

```{r, message=FALSE}
relations_table$membership <- round(runif(nrow(relations_table)), 2)
fuzzy_sets <- FuzzySets(relations_table, gene_data, set_data)
fuzzy_sets
```

The `membership` function associated with each relation can be directly accessed using the getter of the same name.

```{r}
membership(fuzzy_sets)
```

Conveniently, the `relations` accessor returns fuzzy relations as a `DataFrame` that includes the `"membership"` column, along with any other optional metadata accompanying the relations between elements and sets.

```{r}
relations(fuzzy_sets)
```

# Subsetting

The `subset` method can be applied to a `BaseSets` object, using a logical expression that may refer to the `"element"` and `"set"` columns as well as any metadata associated with the relations, indicating rows to keep.

```{r}
subset(base_sets, set == "geneset1" | element %in% c("C") | extra1 == "ABC")
```

Similarly, the `subset` method can be also applied to a `FuzzySets` object, where the logical expression may also refer to the additional `"membership"` metadata.

```{r}
subset(fuzzy_sets, set == "geneset2" & membership > 0.3)
```

# Converting to other formats

It is possible to extract the gene sets as a `list`, for use with functions such as `lapply`.

```{r}
as(fuzzy_sets, "list")
```

It is also possible to visualize membership between gene and gene sets as a matrix.

Notably, `BaseSets` return a `logical` matrix of binary membership that indicates whether each element is associated at least once with each set:

```{r}
base_matrix <- as(base_sets, "matrix")
base_matrix
```

In contrast, `FuzzySets` return a `double` matrix displaying the membership function for each relation.
Relations that are not described in the `FuzzySets` are filled with `NA`.

```{r}
fuzzy_matrix <- as(fuzzy_sets, "matrix")
fuzzy_matrix
```

# Converting from other formats

## Matrix {#fromMatrix}

It is possible to convert incidence matrices into objects derived from the `BaseSets` class.

Notably, `BaseSets` are suitable for `logical` matrices indicating binary membership.

```{r}
as(base_matrix, "BaseSets")
```

Similarly, `FuzzySets` are suitable for `double` matrices indicating the membership function for each relation.
Importantly, relations described as `NA` are not imported into the `FuzzySets` object.
In contrast, relations with a membership function of 0 are imported and described as such.

```{r}
fuzzy_matrix[1, 1] <- 0
as(fuzzy_matrix, "FuzzySets")
```

# Additional information

The number of relations between elements and sets can be obtained using the `length` method.

```{r}
length(base_sets)
```

The number of unique elements and sets can be obtained using the `nElements` and `nSets` methods.

```{r}
nElements(base_sets)
nSets(base_sets)
```

The size of each gene set can be obtained using the `setLengths` method.

```{r}
setLengths(fuzzy_sets)
```

Conversely, the number of sets associated with each gene is returned by the `elementLengths` function.

```{r}
elementLengths(fuzzy_sets)
```

The identifiers of elements and sets can be inspected and renamed using `setIds` and 

```{r}
elementIds(base_sets) <- paste0("Gene", seq_len(nElements(base_sets)))
elementIds(base_sets)
setIds(base_sets) <- paste0("Geneset", seq_len(nSets(base_sets)))
setIds(base_sets)
```

# Session info {.unnumbered}

```{r sessionInfo, echo=FALSE}
sessionInfo()
```
